# ══════════════════════════════════════════════════════════════
# REPO SETUP CHECKLIST (do once in GitHub → Settings):
#
# 1. Auto-Merge:
#    Settings → General → ✅ Allow auto-merge
#
# 2. Branch Protection Rules for `main`:
#    Settings → Branches → Add rule → Branch name pattern: main
#      ✅ Require a pull request before merging
#      ✅ Require status checks to pass before merging
#         → Add required checks:
#              Quality · Backend
#              Quality · Frontend
#              Unit Tests · Backend
#              Unit Tests · Frontend
#              Integration Tests · Backend
#              E2E Tests · Playwright
#      ✅ Require branches to be up to date before merging
#      ✅ Do not allow bypassing the above settings
# ══════════════════════════════════════════════════════════════
name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch on new pushes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PNPM_VERSION: "10.29.3"
  NODE_BACKEND: "24"
  NODE_FRONTEND: "20"

# ──────────────────────────────────────────────────────────────
# JOB 1 — Code Quality (lint + type-check, parallel)
# ──────────────────────────────────────────────────────────────
jobs:
  quality-backend:
    name: "Quality · Backend"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_BACKEND }}
          cache: pnpm
          cache-dependency-path: backend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Generate Prisma client — required for TypeScript to resolve
      # the types exported from src/generated/prisma (gitignored).
      - name: Generate Prisma client
        run: pnpm prisma generate

      - name: Lint
        run: pnpm lint

      - name: Type-check
        run: pnpm exec tsc -p tsconfig.build.json --noEmit

  quality-frontend:
    name: "Quality · Frontend"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_FRONTEND }}
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type-check
        run: pnpm exec tsc --noEmit

# ──────────────────────────────────────────────────────────────
# JOB 2 — Unit Tests (parallel, gated on quality)
# ──────────────────────────────────────────────────────────────
  unit-backend:
    name: "Unit Tests · Backend"
    runs-on: ubuntu-latest
    needs: quality-backend
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_BACKEND }}
          cache: pnpm
          cache-dependency-path: backend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm prisma generate

      - name: Run unit tests
        run: pnpm test

  unit-frontend:
    name: "Unit Tests · Frontend"
    runs-on: ubuntu-latest
    needs: quality-frontend
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_FRONTEND }}
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test

# ──────────────────────────────────────────────────────────────
# JOB 3a — Integration Tests (backend e2e suite + real Postgres)
# ──────────────────────────────────────────────────────────────
  integration-backend:
    name: "Integration Tests · Backend"
    runs-on: ubuntu-latest
    needs: unit-backend
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: chatapp_test
          POSTGRES_PASSWORD: chatapp_test_pass
          POSTGRES_DB: chatapp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U chatapp_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_BACKEND }}
          cache: pnpm
          cache-dependency-path: backend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm prisma generate

      - name: Create .env.test
        run: |
          cat > .env.test << EOF
          NODE_ENV=test
          PORT=4000
          DATABASE_URL=postgresql://chatapp_test:chatapp_test_pass@localhost:5432/chatapp_test
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          CORS_ORIGIN=http://localhost:3000
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          LIVEKIT_API_KEY=${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET=${{ secrets.LIVEKIT_API_SECRET }}
          LIVEKIT_URL=ws://localhost:7880
          EOF

      - name: Run migrations
        run: pnpm prisma migrate deploy
        env:
          DATABASE_URL: postgresql://chatapp_test:chatapp_test_pass@localhost:5432/chatapp_test

      - name: Run integration tests
        run: pnpm test:e2e

# ──────────────────────────────────────────────────────────────
# JOB 3b — E2E Tests (Playwright via docker-compose full stack)
# ──────────────────────────────────────────────────────────────
  e2e:
    name: "E2E Tests · Playwright"
    runs-on: ubuntu-latest
    needs: [unit-backend, unit-frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create backend/.env.test
        run: |
          cat > backend/.env.test << EOF
          NODE_ENV=test
          PORT=4000
          DATABASE_URL=postgresql://chatapp_test:chatapp_test_pass@postgres:5432/chatapp_test
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          CORS_ORIGIN=http://localhost:3000,http://frontend:3000
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          LIVEKIT_API_KEY=${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET=${{ secrets.LIVEKIT_API_SECRET }}
          LIVEKIT_URL=ws://livekit:7880
          EOF

      - name: Create frontend/.env
        run: |
          echo "NEXT_PUBLIC_BACKEND_URL=http://backend:4000" > frontend/.env

      # backend/.env is declared in docker-compose.yml env_file; it must exist
      # even though the real test values come from backend/.env.test (override).
      - name: Create backend/.env (placeholder)
        run: touch backend/.env

      # The root .env is read by the livekit service via env_file in docker-compose.yml.
      # Docker Compose errors if the file is absent, even when livekit runs in --dev mode.
      - name: Create root .env
        run: |
          cat > .env << EOF
          LIVEKIT_API_KEY=${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET=${{ secrets.LIVEKIT_API_SECRET }}
          EOF

      - name: Boot full stack and run E2E suite
        run: |
          docker compose \
            -f docker-compose.yml \
            -f docker-compose.test.yml \
            up --build --exit-code-from e2e --abort-on-container-exit

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 7

      - name: Upload test result traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: e2e/test-results/
          retention-days: 7

      - name: Tear down stack
        if: always()
        run: |
          docker compose \
            -f docker-compose.yml \
            -f docker-compose.test.yml \
            down -v --remove-orphans

# ──────────────────────────────────────────────────────────────
# JOB 4 — Build Verification (production images, gated on all tests)
# Uses GitHub Actions cache backend for BuildKit layer caching.
# ──────────────────────────────────────────────────────────────
  build-images:
    name: "Build · Production Images"
    runs-on: ubuntu-latest
    needs: [integration-backend, e2e]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend production image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          target: production
          push: false
          tags: chat-app/backend:${{ github.sha }}
          # GHA cache preserves BuildKit layers between workflow runs.
          # The pnpm fetch layer is reused as long as pnpm-lock.yaml is unchanged.
          cache-from: type=gha,scope=backend-prod
          cache-to: type=gha,mode=max,scope=backend-prod

      - name: Build frontend production image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          target: production
          push: false
          tags: chat-app/frontend:${{ github.sha }}
          cache-from: type=gha,scope=frontend-prod
          cache-to: type=gha,mode=max,scope=frontend-prod
          build-args: |
            NEXT_PUBLIC_BACKEND_URL=${{ secrets.NEXT_PUBLIC_BACKEND_URL }}
